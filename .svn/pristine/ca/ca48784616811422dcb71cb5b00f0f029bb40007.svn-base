<!DOCTYPE html>
<html lang="en">

	<head>
		<title>下一步办理步骤</title>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link href="css/reset.css" rel="stylesheet">
		<link href="css/style.css" rel="stylesheet">
		<link href="css/app.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/mui.min.css" />
		<link rel="stylesheet" href="css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="css/myCss.css" />
		<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	</head>
	<style>
	#selBtn{
		width: 100%;
		height: 44px;
	}
	p{
		font-size: 90%;
	}
	</style>
	<body>
		<!--header-->
		<header class="i_header">
			<div class="header-left">
				<a class="mui-icon mui-icon-left-nav mui-pull-left mui-action-back"></a>
			</div>
			<center class="header-center">标题</center>
		</header>
		
		<!--main-->
		<main class="pageManage-main">
			<p>当前步骤：<span id="currentActivitiInfo"></span></p>
			<a class="select-down-a" href="javascript:">
				<select class="select-down">
					<option value="1">请选择</option>
				</select>
			</a>
			<p id="sel-person-p" >下一步处理人:</p>
			<a id="sel-person" class="choose-handle"><button id='selBtn'><i class="fa fa-plus-circle" aria-hidden="true"></i><span>选择处理人</span></button></a>
			<p>审批意见:</p>
			<textarea></textarea>
			<input type="checkbox" id='sendMessage' checked="checked" name="" /><span class="send-mess">同时发消息给处理人</span>
			<a id='btn'><input type="button" id='submitSave' value="提交"></a>
		</main>

		<!--pop-->
<!--		<div id="popover" class="mui-popover mui-scroll-wrapper">
			<ul class="mui-table-view mui-scroll">
			</ul>
		</div>
		<div class="select-pop" id="select-pop">
			<ul class="mui-table-view mui-table-view-radio">
				<li class="mui-table-view-cell mui-selected">
					<a class="mui-navigate-right">
						负责人
					</a>
				</li>
			</ul>
		</div>-->
	</body>
<script src="js/mui.min.js"></script>
<script type="text/javascript" src="js/mui.picker.min.js" ></script>
<script type="text/javascript" src="js/common.js" ></script>
<script type="text/javascript" src="js/jquery.js" ></script>
<script>
mui.plusReady(function(){
	var page=plus.webview.getWebviewById("managementLink");
	var fId = page.fId;
	var processDefinitionId = page.processDefinitionId;
	var actBusinData = page.actBusinData;
	var firstWorkTask = page.firstWorkTask;
	var processCode = page.firstWorkTask.processCode;
	var usedAccountInfo = JSON.parse(plus.storage.getItem('usedAccountInfo'));
	var userID_processCode = usedAccountInfo.id+processCode;
	console.log(userID_processCode)
	var nextActivityInfo,nextAsignee,transaction_id,currentActivitysInfo,firstHistoryActUser;
	//plus.webview.close('listParent','none');
	$("#sel-person-p").hide();
	$('#sel-person').hide();
	$('.select-down').change(function(){
		if($('.select-down').val() != '1' &&$('.select-down').val() != '0'){// 1请选择 0退回
			$('#sel-person-p').show();
			$("#sel-person").show();
			$('textarea').html('同意')
		}else{
			$("#sel-person-p").hide();
			$('#sel-person').hide();
			$('textarea').html('')
		}
	})
	getCurrentActivitiInfo();
	getNextActivitiInfo();

	// 当前任务流程属性信息  - 已发起
	function getCurrentActivitiInfo(){
		var json={"data":{"selectDatas":[{"queryMode":"table","dataSource":"TEMP_PROCESS_TASK","name":["v_workflow_rt_task"],"field":["id","ProcessDefinitionId","ProcessInstanceId","auditOpinion","Modified","OwnerName","ActivityId","ActivityName"],"condition":"(  id  =  :v_workflow_rt_task_id_0_CONDITION_KEY_SUFFIX )","valueParamMap":{"v_workflow_rt_task_id_0_CONDITION_KEY_SUFFIX":"4028472d5e507554015e50dfd9dc0d85"}}]}};
		json.data.selectDatas[0].valueParamMap.v_workflow_rt_task_id_0_CONDITION_KEY_SUFFIX=fId;
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
			type: 'POST',
			url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
			data: {
				'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
				'operation':'Find',
				'ajaxRequest':'true',
				'token':jsonStr
			},
			success: function(result){
				//console.log(JSON.stringify(result.data.resultDatas[0].datas.values));
				currentActivitysInfo = result.data.resultDatas[0].datas.values[0];
				$('#currentActivitiInfo').html(result.data.resultDatas[0].datas.values[0].ActivityName)
			},
			dataType: "json"
		});
	}
	//获取下一审批环节名称 getNextActivitiInfo  - 已发起
	function getNextActivitiInfo(){
		var json={"data":{"ruleInstId":"c1b835f8f6e94e4494ce5bf5af33080d","inputParams":{"moduleId":"f2a41afd81a44eac976c4ea45cb7e6b8","command":"getNextActivitys","processDefinitionId":"","processInstanceId":"","taskId":"4028472d5e507554015e50dfd9dc0d85","variables":{"DefaultLoginUserId":"741476a7c5b178b2bedf1f062d17b26b","DefaultLoginUserName":"丁东升"}}}};
		//json.data.selectDatas[0].conditionParams.processDefinitionId.paramValue=firstWorkTask.processDefinitionId;
		json.data.inputParams.taskId=fId;
		json.data.inputParams.processDefinitionId='';
		json.data.inputParams.processInstanceId='';
		json.data.inputParams.variables.DefaultLoginUserId='';
		json.data.inputParams.variables.DefaultLoginUserName='';
		
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
		    type: 'POST',
		    url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
		    data: {
			    'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
			    'operation':'WebExecuteRule',
			    'ajaxRequest':'true',
			    'token':jsonStr
		    },
		    success: function(result){
			    console.log(JSON.stringify(result));
				nextActivityInfo=result.data.nextActivitys[0];
				getNextActivitiApprovalUserList(nextActivityInfo);
				var json={"data":{"selectDatas":[{"queryMode":"custom","dataSource":"TEMP_Activitys","queryFrom":"NAME","selectExpression":"WorkFlow_FindActivitysByIdString","conditionParams":{"activityIdsString":{"paramName":"activityIdsString","paramValue":"4"},"processDefinitionId":{"paramName":"processDefinitionId","paramValue":"a7c8f512ef60a22c220a7fcbbe20c978"}},"extraCondition":"1 = 1","recordStart":-1,"pageSize":-1}]}};
				json.data.selectDatas[0].conditionParams.processDefinitionId.paramValue=processDefinitionId;
				json.data.selectDatas[0].conditionParams.activityIdsString.paramValue=parseInt(nextActivityInfo.id);
				var jsonStr = encodeURI(JSON.stringify(json));
				$.ajax({
					type: 'POST',
					url: ip+"module-operation!executeOperation?moduleId="+actBusinData.bussId,
					data: {
						'moduleId':actBusinData.bussId,
						'operation':'Find',
						'ajaxRequest':'true',
						'token':jsonStr
					},
					success: function(result){
						//console.log(JSON.stringify(result.data.resultDatas[0].datas));
						var values=result.data.resultDatas[0].datas.values
						for(var i=0;i<values.length;i++){
							$('.select-down').append('<option value="'+values[i].id+'">'+values[i].ActivityName+'</option>')
						}
						$('.select-down').append('<option value="0">退回</option>')

					},
					dataType: "json"
				});
		    },
		    dataType: "json"
		});
		
	}
	// 获取下一步审批人列表 - 已发起
	function getNextActivitiApprovalUserList(nextActivityInfo){
		if(nextActivityInfo.isEnd==true){ // 下一步结束，不用选人
			nextAsignee=null;
			mui.toast("下一步结束，不用选人");
			$('#sel-person-p').remove();
			$('#sel-person').remove()
			
		}else{
		var json={"data":{"selectDatas":[{"queryMode":"custom","dataSource":"TEMP_ExecurtionUnits","queryFrom":"NAME","selectExpression":"WorkFlow_FindProcessExecutionUnits","conditionParams":{"taskId":{"paramName":"taskId","paramValue":"4028472d5e73fce6015e744911371fa3"},"processDefinitionId":{"paramName":"processDefinitionId","paramValue":"3e5efc2cd62a88f1f334ec38a9f7159b"},"activityId":{"paramName":"activityId","paramValue":"7"}},"extraCondition":"1 = 1","recordStart":-1,"pageSize":-1}]}};
		json.data.selectDatas[0].conditionParams.activityId.paramValue=nextActivityInfo.id;
		json.data.selectDatas[0].conditionParams.processDefinitionId.paramValue=firstWorkTask.processDefinitionId;
		json.data.selectDatas[0].conditionParams.taskId.paramValue=firstWorkTask.id;
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
			type: 'POST',
			url: ip+"module-operation!executeOperation?moduleId=973a578d18004f7494de434520ee6d58",
			data: {
				'moduleId':'973a578d18004f7494de434520ee6d58',
				'operation':'Find',
				'ajaxRequest':'true',
				'token':jsonStr
			},
				success: function(result){
					var userPicker = new mui.PopPicker()
					var dataJson=[];
					var values = result.data.resultDatas[0].datas.values;
					console.log(JSON.stringify(result.data.resultDatas[0].datas.recordCount))
					if(result.data.resultDatas[0].datas.recordCount>1){
						for(var i=1;i<values.length;i++){
							dataJson.push({value:values[i].id,text:values[i].ExecutionUnitName})
						}
					}else{
						mui.toast('请在电脑上设置审批人')
					}
					userPicker.setData(dataJson);
					if(plus.storage.getItem(userID_processCode) != null){
						nextAsignee =JSON.parse(plus.storage.getItem(userID_processCode));
						$('#sel-person span').html(nextAsignee.ExecutionUnitName);
					}
					$('#sel-person').on('tap',function(){
						userPicker.show(function(items) {
							$('#sel-person span').html(items[0].text);
							var nextId = items[0].value;
							for(var i=0;i<values.length;i++){
								if(nextId == values[i].id){
									nextAsignee = values[i];
									break;
								}
							}
							plus.storage.setItem(userID_processCode,JSON.stringify(nextAsignee));
						})
					})
					
					
					
					/*var idsArray = [];
					var list = result.data.resultDatas[0].datas.values;
					console.log(JSON.stringify(list))
					for(var i=0; i<list.length; i++){
						idsArray.push(list[i].ExecutionUnitValue)
					}
					var idsArrayStr = idsArray.join(",");
					var userkind = usedAccountInfo.userkind;
					var InnerCode = usedAccountInfo.InnerCode;
					$.ajax({
						type: 'POST',
						url: ip2+"app/getApprovalUserList",
						data: {
							idsArrayStr: idsArrayStr,
							userkind: userkind,
							InnerCode: InnerCode
						},
						success: function(result){	
							//console.log(JSON.stringify(result.data));
							var userPicker = new mui.PopPicker()
							var dataJson=[];
							var values = result.data
							if(result.data.length>1){
								for(var i=0;i<values.length;i++){
									dataJson.push({value:values[i].id,text:values[i].ExecutionUnitName})
								}
							}else{
								mui.toast('请在电脑上设置审批人')
							}
							userPicker.setData(dataJson)
							$('#sel-person').on('tap',function(){
								userPicker.show(function(items) {
									$('#sel-person span').html(items[0].text);
									var nextId = items[0].value;
									for(var i=0;i<values.length;i++){
										if(nextId == values[i].id){
											nextAsignee = values[i];
											break;
										}
									}
									console.log(JSON.stringify(nextAsignee))
								})
							})
						},
						dataType: "json"
					});*/
				},
				dataType: "json"
			});
		}
	}
	$('#submitSave').on('tap',function(){
		$("#submitSave").attr('disabled',true)
		$("#submitSave").css('background','grey')
		var chars = ['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f']
		transaction_id='';
		for(var j = 0;j < 32 ; j ++) {
	         var id = Math.ceil(Math.random()*15);
	         transaction_id += chars[id];
	    }
		//1. 查询当前任务 是否 可以提交，是否可以退回
		var json={"data":{"ruleInstId":"045c2188a88e466789ef04408f11098a","inputParams":{"moduleId":"f2a41afd81a44eac976c4ea45cb7e6b8","taskId":"4028472d5e574c4f015e575ec661082e","queryCanComplete":true,"queryCanReject":true,"queryCanRetrieve":false}}};
		json.data.inputParams.taskId=fId;
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
			type: 'POST',
			url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
			data: {
				'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
				'operation':'WebExecuteRule',
				'ajaxRequest':'true',
				'token':jsonStr
			},
			success: function(result){
					console.log('yes')
				if(result.data.CanComplete == true){ // 可以提交
					//2. 开启事务
					var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_begin"}};
					json.data.transaction_id=transaction_id; // 事务ID
					var jsonStr = encodeURI(JSON.stringify(json));
					$.ajax({
						type: 'POST',
						url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
						data: {
							'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
							'operation':'Transaction',
							'ajaxRequest':'true',
							'token':jsonStr
						},
						success: function(result){	
							//console.log(JSON.stringify(result))
							//result: {"msg":"","data":{},"success":true,"log":""}
							if(result.success == true){ // 事务开启
								//3. 更新-保存数据
								var json={"data":{"saveDatas":[{"metadata":{"model":[{"object":"oa_form_inst","fields":[{"code":"bizTableName","name":"表单主表","type":"char","length":"32","precision":"0"},{"code":"sendOrgName","name":"发起单位","type":"char","length":"256","precision":"0"},{"code":"formTitle","name":"标题","type":"char","length":"512","precision":"0"},{"code":"id","name":"id","type":"char","length":"64","precision":"0"},{"code":"editFormWndId","name":"表单窗体ID","type":"char","length":"64","precision":"0"},{"code":"docReviewMark","name":"保留痕迹","type":"boolean","length":"50","precision":"0"},{"code":"bussId","name":"业务记录ID","type":"char","length":"64","precision":"0"},{"code":"ProcessBizDataRelaId","name":"业务组件关联ID","type":"char","length":"64","precision":"0"},{"code":"formDefineId","name":"表单定义ID","type":"char","length":"64","precision":"0"},{"code":"docShowReviMark","name":"显示痕迹","type":"boolean","length":"50","precision":"0"},{"code":"senderId","name":"发起人ID","type":"char","length":"64","precision":"0"},{"code":"formStatus","name":"表单状态","type":"char","length":"32","precision":"0"},{"code":"processInstanceId","name":"流程实例ID","type":"char","length":"64","precision":"0"},{"code":"bussComponentId","name":"业务窗体ID","type":"char","length":"64","precision":"0"},{"code":"sendTime","name":"发起时间","type":"char","length":"32","precision":"0"},{"code":"processDefineId","name":"流程定义ID","type":"char","length":"64","precision":"0"},{"code":"senderName","name":"发起人","type":"char","length":"32","precision":"0"},{"code":"docDefendMark","name":"文档保护","type":"boolean","length":"50","precision":"0"},{"code":"isHaveDoc","name":"有否正文","type":"boolean","length":"50","precision":"0"},{"code":"bussTableName","name":"业务主表","type":"char","length":"64","precision":"0"},{"code":"sendOrgId","name":"发起单位ID","type":"char","length":"64","precision":"0"}]}]},"datas":{"values":[{"bizTableName":null,"sendOrgName":"","formTitle":"【零星材料采购支付】ZFSP-C-ZR34SYB-CQCHWL-2017-005QTKS2017024201709","id":"ace832ced54cc915ddb31e0d65ed9f63","editFormWndId":"","docReviewMark":true,"bussId":"a04647115b77ef248f81e2e2cb00efab","ProcessBizDataRelaId":"8e485a5f6cd564a0652718ddb56c4ab1","formDefineId":"a7c8f512ef60a22c220a7fcbbe20c978","docShowReviMark":false,"senderId":"","formStatus":"审批","processInstanceId":"ace832ced54cc915ddb31e0d65ed9f63","bussComponentId":"557eab92e8b34aaabed3a6a354c936aa","sendTime":"2017-09-06 21:24:11","processDefineId":"a7c8f512ef60a22c220a7fcbbe20c978","senderName":"","docDefendMark":false,"isHaveDoc":false,"bussTableName":"iefc_FundPay","sendOrgId":"","__ds_state__":"insertorupdate"}],"recordCount":0},"dataSource":"oa_form_inst"}],"saveMode":"cascadeSave","treeStructMapArray":null,"transaction_id":"ace398047c325df3593adb4cfc0a5826"}};
								json.data.saveDatas[0].datas.values[0].bussComponentId=actBusinData.bussComponentId;
								json.data.saveDatas[0].datas.values[0].ProcessBizDataRelaId=actBusinData.ProcessBizDataRelaId;
								json.data.saveDatas[0].datas.values[0].bussTableName=actBusinData.bussTableName;
								json.data.saveDatas[0].datas.values[0].bussId=actBusinData.bussId;
								json.data.saveDatas[0].datas.values[0].docDefendMark=actBusinData.docDefendMark;
								json.data.saveDatas[0].datas.values[0].docReviewMark=actBusinData.docReviewMark;
								json.data.saveDatas[0].datas.values[0].docShowReviMark=actBusinData.docShowReviMark;
								json.data.saveDatas[0].datas.values[0].isHaveDoc=actBusinData.isHaveDoc;
								json.data.saveDatas[0].datas.values[0].formStatus=actBusinData.formStatus;
								json.data.saveDatas[0].datas.values[0].formDefineId=actBusinData.formDefineId;
								json.data.saveDatas[0].datas.values[0].formTitle=actBusinData.formTitle;
								json.data.saveDatas[0].datas.values[0].editFormWndId=actBusinData.editFormWndId;
								json.data.saveDatas[0].datas.values[0].id=actBusinData.id;
								json.data.saveDatas[0].datas.values[0].processDefineId=actBusinData.processDefineId;
								json.data.saveDatas[0].datas.values[0].processInstanceId=actBusinData.processInstanceId;
								json.data.saveDatas[0].datas.values[0].sendOrgId=actBusinData.sendOrgId;
								json.data.saveDatas[0].datas.values[0].sendOrgName=actBusinData.sendOrgName;
								json.data.saveDatas[0].datas.values[0].sendTime=actBusinData.sendTime;
								json.data.saveDatas[0].datas.values[0].senderId=actBusinData.senderId;
								json.data.saveDatas[0].datas.values[0].senderName=actBusinData.senderName;
								json.data.transaction_id=transaction_id;
								var jsonStr = encodeURI(JSON.stringify(json));
								$.ajax({
									type: 'POST',
									url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
									data: {
										'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
										'operation':'Save',
										'ajaxRequest':'true',
										'token':jsonStr
									},
									success: function(result){
										//console.log(JSON.stringify(result))
										//$("#resultArea").val(JSON.stringify(result));
										//result: {"msg":"","data":{},"success":true,"log":""}
										if(result.success == true){ // 保存成功
											//4.保存审批意见
											var json={"data":{"saveDatas":[{"dataSource":"v_workflow_rt_task","datas":{"recordCount":1,"values":[{"auditOpinion":"12231234567","id":"4028472d5e5b0965015e5b3d0cb40bb6","__ds_state__":"insertorupdate"}]},"metadata":{"model":[{"fields":[],"object":"v_workflow_rt_task"}]}}],"saveMode":"cascadeSave","treeStructMapArray":null,"transaction_id":"ace398047c325df3593adb4cfc0a5826"}};
											json.data.transaction_id=transaction_id;
											json.data.saveDatas[0].datas.values[0].id=fId;
											json.data.saveDatas[0].datas.values[0].auditOpinion=$('textarea').val();
											var jsonStr = encodeURI(JSON.stringify(json));
											$.ajax({
												type: 'POST',
												url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
												data: {
													'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
													'operation':'Save',
													'ajaxRequest':'true',
													'token':jsonStr
												},
												success: function(result){
													//console.log(JSON.stringify(result));
													//result: {"msg":"","data":{},"success":true,"log":""}
													if(result.success == true){ // 保存审批意见成功， 提交数据--提交事务
														var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
														json.data.transaction_id=transaction_id;
														var jsonStr = encodeURI(JSON.stringify(json));
														$.ajax({
															type: 'POST',
															url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
															data: {
																'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
																'operation':'Transaction',
																'ajaxRequest':'true',
																'token':jsonStr
															},
															success: function(result){
																if(result.success){
																	if($('.select-down').val() != '1'){
																		if($('.select-down').val() == '0'){
																			queryTodoTaskRefuse()
																		}else{
																			submitTask()
																		}
																	}else{
																		mui.toast('请选择下一步骤')
																	}
																}
																
															},
															dataType: "json"
														});
													}else{
														$("#resultArea").val(JSON.stringify(result));
														mui.toast('保存审批意见数据失败');
													}
												},
												dataType: "json"
											});
										}else{
											mui.toast('保存审批意见数据失败');
										}
									},
									dataType: "json"
								});
							}else{
								mui.toast("开启事务失败");
							}
						},
						dataType: "json"
					});
				}else{
					mui.toast("不允许提交");
				}
			},
			dataType: "json"
		});
	})
	function submitTask(){
		//1. 查询当前任务 是否 可以提交，是否可以退回
		var json={"data":{"ruleInstId":"045c2188a88e466789ef04408f11098a","inputParams":{"moduleId":"f2a41afd81a44eac976c4ea45cb7e6b8","taskId":"4028472d5e574c4f015e575ec661082e","queryCanComplete":true,"queryCanReject":true,"queryCanRetrieve":false}}};
		json.data.inputParams.taskId=fId;
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
			type: 'POST',
			url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
			data: {
				'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
				'operation':'WebExecuteRule',
				'ajaxRequest':'true',
				'token':jsonStr
			},
			success: function(result){
				//console.log(JSON.stringify(result));
				if(result.data.CanComplete == true){ // 可以提交
					if(nextActivityInfo.isEnd==true){ // 提交后流程结束
						//1. 完成当前任务
						var json={"data":{"ruleInstId":"c1b835f8f6e94e4494ce5bf5af33080d","inputParams":{"taskId":"4028472d5e5b0965015e5b1aa1db0885","nextActivityIds":"6","nextExecutionUnitIds":"-1","variables":{"DefaultLoginUserId":"2b1a3838cf668eb9c3b60ff1fa5f2237","DefaultLoginUserName":"朱华俊"},"command":"workFlowTaskComplete"}}};
						json.data.inputParams.nextActivityIds=nextActivityInfo.id; // 下一节点ID
						json.data.inputParams.taskId=firstWorkTask.id;
						json.data.inputParams.nextExecutionUnitIds='-1';
						json.data.inputParams.variables.DefaultLoginUserId=usedAccountInfo.userId;
						json.data.inputParams.variables.DefaultLoginUserName=usedAccountInfo.userName;
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
							data: {
								'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								//console.log(JSON.stringify(result));
								if(result.success==true){
									var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_begin"}};
									json.data.transaction_id=transaction_id; // 事务ID
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'Transaction',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											console.log(JSON.stringify(result))
											if(result.success == true){ // 事务开启
													todoTaskAgreeComplate(result)
												}else{
													mui.toast("开启事务失败");
												}
											},
											dataType: "json"
										});
								}else{
									mui.toast("任务失败");
								}
							},
							dataType: "json"
						});
						
					}else{
						// 2设置下一审批人
						var json={"data":{"ruleInstId":"5bd534c3680d4413b990fc3f475f095c","inputParams":{"code":"com.toone.itop.formula.function.epm.flow.SetFlowVariable","IsSync":true,"params":[{"param":"executionId","paramvalue":"4028472d5e59babb015e5a922cce0d55"},{"param":"variableName","paramvalue":"BizUserIdStr"},{"param":"variableValue","paramvalue":"2b1a3838cf668eb9c3b60ff1fa5f2237"}]}}};
						json.data.inputParams.params[0].paramvalue=firstWorkTask.executionId; //executionId
						json.data.inputParams.params[2].paramvalue=nextAsignee.ExecutionUnitValue; // 下一审批人ID
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url: ip+"module-operation!executeOperation?moduleId=973a578d18004f7494de434520ee6d58",
							data: {
								'moduleId':'973a578d18004f7494de434520ee6d58',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								//console.log(JSON.stringify(result));
								//result: {"msg":"","data":null,"success":true,"log":""}
								if(result.success == true){
									//3. 完成当前任务
									var json={"data":{"ruleInstId":"c1b835f8f6e94e4494ce5bf5af33080d","inputParams":{"taskId":"4028472d5e59babb015e5a922ce80d59","nextActivityIds":"4","nextExecutionUnitIds":"","variables":{"DefaultLoginUserId":"741476a7c5b178b2bedf1f062d17b26b","DefaultLoginUserName":"丁东升"},"command":"workFlowTaskComplete"}}};
									json.data.inputParams.nextActivityIds=nextActivityInfo.id; // 下一节点ID
									json.data.inputParams.nextExecutionUnitIds=nextAsignee.ExecutionUnitValue; // 下一审批人ID
									json.data.inputParams.taskId=firstWorkTask.id;
									json.data.inputParams.variables.DefaultLoginUserId=usedAccountInfo.userId;
									json.data.inputParams.variables.DefaultLoginUserName=usedAccountInfo.userName;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'WebExecuteRule',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											//console.log(JSON.stringify(result));
											if(result.success){
												mui.toast('提交成功');
												getNum()
												openListWindow();
												sendMessage();																									
											}
										},
										dataType: "json"
									});
								}else{
									mui.toast('设置下一审批人失败');
								}
							},
							dataType: "json"
						});
					}
				}else{
					mui.toast("不允许再次提交");
				}
			},
			dataType: "json"
		});
	}
	function todoTaskAgreeComplate(result){
		var payArr = ['LXSBZLZF','LXCLCGZF','LXSBCGZF','LXQTZF','LXZCZLZF','SBCGHTZF','ZCZLHTZF','SBZLHTZF','QTHTZF','CLCGHTZF','LWFBHTZF','ZYFBHTZF'];
		var spArr = ["WZSBZLSP","WZSBCGSP"];
		var ydzfArr  = ['XMBYDZF','SYBYDZF']
		if($.inArray(processCode, payArr) != -1){			
			var payJson= {"LXCLCGZF":"3a27617b9f264e449b80da4625eb82af",
			"LXSBCGZF":"ec1036e64c2742cabe9a9dab867cdbe0",
			"LXZCZLZF":"8196bfdb55fc44d6a09c39d45e78b511",
			"LXSBZLZF":"1dfc141104d94a0797fa2aaaf77d3b26",
			"LXQTZF":"69115477ec8e42a6bbd3ed9e6640d4ec",
			"ZYFBHTZF":"a06ce3164c4442e3a2cae135f6bc4800",
			"CLCGHTZF":"2b573a7fa74743b4bbbcf90af9a4d5ba",
			"SBCGHTZF":"de0587c2182e42298905f07b61872dbc",
			"ZCZLHTZF":"477491946eeb4a018ba603b5094ddef9",
			"SBZLHTZF":"10dd7fd4023749cfbbe0d08515571ae5",
			"LWFBHTZF":"e39330c922ef4fcdaeb272f4f66f0e24",
			"QTHTZF":"e561a9bcce8d4c71b1e34353fe8d083f"}
			var json={"data":{"ruleInstId":"3a27617b9f264e449b80da4625eb82af","inputParams":{"condParams":[{"dataSource":"iefc_FundPay","condition":"(  id  =  :iefc_FundPay_id_0_CONDITION_KEY_SUFFIX )","parameters":{"iefc_FundPay_id_0_CONDITION_KEY_SUFFIX":"337f8fa87dd7bc8374953a54b0a87ae2"},"values":[{"destField":"iefc_FundPay.statusFlag","sourceField":9,"valueType":"1"},{"destField":"iefc_FundPay.statusName","sourceField":"审批通过","valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
			json.data.transaction_id=transaction_id;
			json.data.inputParams.condParams[0].parameters.iefc_FundPay_id_0_CONDITION_KEY_SUFFIX=actBusinData.bussId;
			json.data.inputParams.condParams[0].values[0].sourceField='9';// 9 审批通过 // 11 审批不通过
			json.data.inputParams.condParams[0].values[1].sourceField='审批通过'
			json.data.ruleInstId=payJson[processCode];
			var jsonStr = encodeURI(JSON.stringify(json));
			$.ajax({
				type: 'POST',
				url: ip+"module-operation!executeOperation?moduleId="+actBusinData.bussComponentId,
				data: {
					'moduleId':actBusinData.bussComponentId,
					'operation':'WebExecuteRule',
					'ajaxRequest':'true',
					'token':jsonStr
				},
				success: function(result){
					//console.log(JSON.stringify(result));
					//result: {"msg":"","data":null,"success":true,"log":""}
					if(result.success==true){
						var json={"data":{"ruleInstId":"0aa620aea30b48dea7ffbd7e74ad6e3f","inputParams":{"condParams":[{"dataSource":"oa_form_inst","condition":"(  id  =  :oa_form_inst_id_0_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_inst_id_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d"},"values":[{"destField":"oa_form_inst.formStatus","sourceField":"办结","valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
						json.data.transaction_id=transaction_id;
						json.data.inputParams.condParams[0].parameters.oa_form_inst_id_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
						json.data.inputParams.condParams[0].values[0].sourceField='办结';
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
							data: {
								'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								//console.log(JSON.stringify(result));
								//result: {"msg":"","data":null,"success":true,"log":""}
								if(result.success==true){
									//8. 设置 oa_form_opinion.isTemp
									var json={"data":{"ruleInstId":"e012526261e1477eaf7e22be136f3ed8","inputParams":{"condParams":[{"dataSource":"oa_form_opinion","condition":"(  formInstanceId  =  :oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX and  ISNULL(isTemp, 0)  =  :oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX and  activityId  =  :oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX and  opterId  =  :oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d","oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX":true,"oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX":"4","oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX":"2b1a3838cf668eb9c3b60ff1fa5f2237"},"values":[{"destField":"oa_form_opinion.isTemp","sourceField":false,"valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
									json.data.transaction_id=transaction_id;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX=currentActivitysInfo.ActivityId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX=firstWorkTask.owner;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'WebExecuteRule',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											//console.log(JSON.stringify(result));
											//result: {"msg":"","data":null,"success":true,"log":""}
											if(result.success==true){
												// 9. 提交事务
												var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
												json.data.transaction_id=transaction_id;
												var jsonStr = encodeURI(JSON.stringify(json));
												$.ajax({
													type: 'POST',
													url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
													data: {
														'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
														'operation':'Transaction',
														'ajaxRequest':'true',
														'token':jsonStr
													},
													success: function(result){
														//console.log(JSON.stringify(result));
														if(result.success==true){
															mui.toast('提交成功');
															getNum()
															openListWindow();
															sendMessage();	
														}else{mui.toast("提交失败");}
													},
													dataType: "json"
												});
											}
										},
										dataType: "json"
									});
								}
							},
							dataType: "json"
						});
					}
				},
				dataType: "json"
			});
		}else if(processCode == "JSLC"){
			var json={"data":{"saveDatas":[{"dataSource":"ieco_cashUp_basicInfo","datas":{"recordCount":1,"values":[{"id":"7ff0e3ff61b0cd5097371e84485fd010","statusFlag":9,"statusName":"审批通过","__ds_state__":"insertorupdate"}]},"metadata":{"model":[{"fields":[],"object":"ieco_cashUp_basicInfo"}]}}],"saveMode":"cascadeSave","treeStructMapArray":null,"transaction_id":"c5fbdfce28aa9b19d549a7de39c781f1"}};
			json.data.transaction_id=transaction_id;
			json.data.saveDatas[0].datas.values[0].id=actBusinData.bussId;
			json.data.saveDatas[0].datas.values[0].statusFlag='9';// 9 审批通过 // 11 审批不通过
			json.data.saveDatas[0].datas.values[0].statusName='审批通过';
			var jsonStr = encodeURI(JSON.stringify(json));
			$.ajax({
				type: 'POST',
				url: ip+"module-operation!executeOperation?moduleId="+actBusinData.bussComponentId,
				data: {
					'moduleId':actBusinData.bussComponentId,
					'operation':'Save',
					'ajaxRequest':'true',
					'token':jsonStr
				},
				success: function(result){
					$("#resultArea").val(JSON.stringify(result));
					//result: {"msg":"","data":null,"success":true,"log":""}
					if(result.success==true){
						//7. 办结
						var json={"data":{"ruleInstId":"0aa620aea30b48dea7ffbd7e74ad6e3f","inputParams":{"condParams":[{"dataSource":"oa_form_inst","condition":"(  id  =  :oa_form_inst_id_0_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_inst_id_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d"},"values":[{"destField":"oa_form_inst.formStatus","sourceField":"办结","valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
						json.data.transaction_id=transaction_id;
						json.data.inputParams.condParams[0].parameters.oa_form_inst_id_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
						json.data.inputParams.condParams[0].values[0].sourceField='办结';
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
							data: {
								'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								//console.log(JSON.stringify(result));
								//result: {"msg":"","data":null,"success":true,"log":""}
								if(result.success==true){
									//8. 设置 oa_form_opinion.isTemp
									var json={"data":{"ruleInstId":"e012526261e1477eaf7e22be136f3ed8","inputParams":{"condParams":[{"dataSource":"oa_form_opinion","condition":"(  formInstanceId  =  :oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX and  ISNULL(isTemp, 0)  =  :oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX and  activityId  =  :oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX and  opterId  =  :oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d","oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX":true,"oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX":"4","oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX":"2b1a3838cf668eb9c3b60ff1fa5f2237"},"values":[{"destField":"oa_form_opinion.isTemp","sourceField":false,"valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
									json.data.transaction_id=transaction_id;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX=currentActivitysInfo.ActivityId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX=firstWorkTask.owner;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'WebExecuteRule',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											//console.log(JSON.stringify(result));
											//result: {"msg":"","data":null,"success":true,"log":""}
											if(result.success==true){
												// 9. 提交事务
												var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
												json.data.transaction_id=transaction_id;
												var jsonStr = encodeURI(JSON.stringify(json));
												$.ajax({
													type: 'POST',
													url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
													data: {
														'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
														'operation':'Transaction',
														'ajaxRequest':'true',
														'token':jsonStr
													},
													success: function(result){
														//console.log(JSON.stringify(result));
														//result: {"msg":"","data":{},"success":true,"log":""}
														if(result.success==true){
															mui.toast('提交成功');
															getNum()
															openListWindow();
															sendMessage();	
														}else{mui.toast("提交失败");}
													},
													dataType: "json"
												});
											}
										},
										dataType: "json"
									});
								}
							},
							dataType: "json"
						});
					}
				},
				dataType: "json"
			});
		}else if(processCode == "WZSBZLSP"){//租赁审批
			var dataDetailInfo = page.dataDetailInfo
			var json={"data":{"saveDatas":[{"metadata":{"model":[{"object":"iect_uc_equipmentHire","fields":[{"code":"statusFlag","name":"审批状态标识","type":"integer","length":"50","precision":"0"},{"code":"hireMethod","name":"租赁方式","type":"char","length":"50","precision":"0"},{"code":"remark","name":"备注","type":"char","length":"2000","precision":"0"},{"code":"prepareDate","name":"登记人日期","type":"date","length":"50","precision":"0"},{"code":"hireCategory","name":"租赁分类","type":"char","length":"50","precision":"0"},{"code":"hireType","name":"租赁类型","type":"char","length":"50","precision":"0"},{"code":"emergeTypeNo","name":"紧急程度编号","type":"char","length":"50","precision":"0"},{"code":"preparerId","name":"登记人Id","type":"char","length":"64","precision":"0"},{"code":"preparer","name":"登记人","type":"char","length":"60","precision":"0"},{"code":"statusName","name":"审批状态名称","type":"char","length":"60","precision":"0"},{"code":"id","name":"主键标识","type":"char","length":"64","precision":"0"},{"code":"projectName","name":"项目名称","type":"char","length":"255","precision":"0"},{"code":"totalMoney","name":"预计租费总额（元）","type":"integer","length":"50","precision":"0"},{"code":"emergeType","name":"紧急程度","type":"char","length":"50","precision":"0"},{"code":"singleMoney","name":"预计单台月租（元/月）","type":"integer","length":"50","precision":"0"},{"code":"hireMethodNo","name":"租赁方式编号","type":"char","length":"50","precision":"0"},{"code":"apprProcess","name":"所属审批流程","type":"char","length":"255","precision":"0"},{"code":"hireItem","name":"租赁事项","type":"char","length":"255","precision":"0"},{"code":"hireCategoryNo","name":"租赁分类编号","type":"char","length":"50","precision":"0"},{"code":"projectId","name":"项目ID","type":"char","length":"64","precision":"0"},{"code":"hireAuditNo","name":"租赁审批号","type":"char","length":"128","precision":"0"},{"code":"apprProcessNo","name":"所属审批流程","type":"char","length":"255","precision":"0"},{"code":"forResult","name":"办理结果","type":"char","length":"2000","precision":"0"},{"code":"resultInfo","name":"长文本结果信息","type":"char","length":"2000","precision":"0"},{"code":"hireTypeNo","name":"租赁类型编号","type":"char","length":"50","precision":"0"}]}]},"datas":{"values":[{"statusFlag":9,"hireMethod":"竞争性谈判","remark":"aaaaaaaaaaa","prepareDate":"2017-09-11","hireCategory":"从外租赁","hireType":"零星周材租赁","emergeTypeNo":"较急","preparerId":"741476a7c5b178b2bedf1f062d17b26b","preparer":"丁东升","statusName":"审批通过","id":"329caa6add3ed7bfa5a3a89885bcbb09","projectName":"重庆传化物流基地有限公司新建项目","totalMoney":111110,"emergeType":"较急","singleMoney":null,"hireMethodNo":"ZJ","apprProcess":"","hireItem":"aaaaaaaaa","hireCategoryNo":"01_hireIn","projectId":"0afd221005e67633bd8907622c41cbf6","hireAuditNo":"SP-Z-ZR34SYB-CQCHWL-2017-014","apprProcessNo":"","forResult":null,"resultInfo":"aaaaaaaaaa","hireTypeNo":"01_lxzc","__ds_state__":"insertorupdate"}],"recordCount":0},"dataSource":"iect_uc_equipmentHire"}],"saveMode":"cascadeSave","treeStructMapArray":null,"transaction_id":"b198dae2c1a2cee627baa6465c83e846"}};
			json.data.transaction_id=transaction_id;
			json.data.saveDatas[0].datas.values[0].id=actBusinData.bussId;
			json.data.saveDatas[0].datas.values[0].statusFlag='9';// 9 审批通过 // 11 审批不通过
			json.data.saveDatas[0].datas.values[0].statusName='审批通过';
			json.data.saveDatas[0].datas.values[0].apprProcess=dataDetailInfo.apprProcess;
			json.data.saveDatas[0].datas.values[0].apprProcessNo=dataDetailInfo.apprProcessNo;
			json.data.saveDatas[0].datas.values[0].emergeType=dataDetailInfo.emergeType;
			json.data.saveDatas[0].datas.values[0].emergeTypeNo=dataDetailInfo.emergeTypeNo;
			json.data.saveDatas[0].datas.values[0].hireAuditNo=dataDetailInfo.hireAuditNo;
			json.data.saveDatas[0].datas.values[0].hireCategory=dataDetailInfo.hireCategory;
			json.data.saveDatas[0].datas.values[0].hireCategoryNo=dataDetailInfo.hireCategoryNo;
			json.data.saveDatas[0].datas.values[0].hireItem=dataDetailInfo.hireItem;
			json.data.saveDatas[0].datas.values[0].hireMethod=dataDetailInfo.hireMethod;
			json.data.saveDatas[0].datas.values[0].hireMethodNo=dataDetailInfo.hireMethodNo;
			json.data.saveDatas[0].datas.values[0].hireType=dataDetailInfo.hireType;
			json.data.saveDatas[0].datas.values[0].hireTypeNo=dataDetailInfo.hireTypeNo;
			json.data.saveDatas[0].datas.values[0].prepareDate=dataDetailInfo.prepareDate;
			json.data.saveDatas[0].datas.values[0].preparer=dataDetailInfo.preparer;
			json.data.saveDatas[0].datas.values[0].preparerId=dataDetailInfo.preparerId;
			json.data.saveDatas[0].datas.values[0].projectId=dataDetailInfo.projectId;
			json.data.saveDatas[0].datas.values[0].projectName=dataDetailInfo.projectName;
			json.data.saveDatas[0].datas.values[0].remark=dataDetailInfo.remark;
			json.data.saveDatas[0].datas.values[0].resultInfo=dataDetailInfo.resultInfo;
			json.data.saveDatas[0].datas.values[0].totalMoney=dataDetailInfo.totalMoney;
			
			var jsonStr = encodeURI(JSON.stringify(json));
			$.ajax({
				type: 'POST',
				url: ip+"module-operation!executeOperation?moduleId="+actBusinData.bussComponentId,
				data: {
					'moduleId':actBusinData.bussComponentId,
					'operation':'Save',
					'ajaxRequest':'true',
					'token':jsonStr
				},
				success: function(result){
					$("#resultArea").val(JSON.stringify(result));
					//result: {"msg":"","data":null,"success":true,"log":""}
					if(result.success==true){
						//7. 办结
						var json={"data":{"ruleInstId":"0aa620aea30b48dea7ffbd7e74ad6e3f","inputParams":{"condParams":[{"dataSource":"oa_form_inst","condition":"(  id  =  :oa_form_inst_id_0_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_inst_id_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d"},"values":[{"destField":"oa_form_inst.formStatus","sourceField":"办结","valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
						json.data.transaction_id=transaction_id;
						json.data.inputParams.condParams[0].parameters.oa_form_inst_id_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
						json.data.inputParams.condParams[0].values[0].sourceField='办结';
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
							data: {
								'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								$("#resultArea").val(JSON.stringify(result));
								//result: {"msg":"","data":null,"success":true,"log":""}
								if(result.success==true){
									// 9. 提交事务
									var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
									json.data.transaction_id=transaction_id;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'Transaction',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											if(result.success==true){
												mui.toast('提交成功');
												getNum()
												openListWindow();
												sendMessage();	
											}else{mui.toast("提交失败");}
										},
										dataType: "json"
									});
/*									//8. 设置 oa_form_opinion.isTemp
									var json={"data":{"ruleInstId":"e012526261e1477eaf7e22be136f3ed8","inputParams":{"condParams":[{"dataSource":"oa_form_opinion","condition":"(  formInstanceId  =  :oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX and  ISNULL(isTemp, 0)  =  :oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX and  activityId  =  :oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX and  opterId  =  :oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d","oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX":true,"oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX":"4","oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX":"2b1a3838cf668eb9c3b60ff1fa5f2237"},"values":[{"destField":"oa_form_opinion.isTemp","sourceField":false,"valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
									json.data.transaction_id=transaction_id;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX=currentActivitysInfo.ActivityId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX=firstWorkTask.owner;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'WebExecuteRule',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											if(result.success==true){
												// 9. 提交事务
												var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
												json.data.transaction_id=transaction_id;
												var jsonStr = encodeURI(JSON.stringify(json));
												$.ajax({
													type: 'POST',
													url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
													data: {
														'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
														'operation':'Transaction',
														'ajaxRequest':'true',
														'token':jsonStr
													},
													success: function(result){
														if(result.success==true){
															mui.toast('提交成功');
															getNum()
															openListWindow();
															sendMessage();	
														}else{mui.toast("提交失败");}
													},
													dataType: "json"
												});
											}
										},
										dataType: "json"
									});*/
								}
							},
							dataType: "json"
						});
					}
				},
				dataType: "json"
			});
		}else if(processCode == "WZSBCGSP"){//采购审批
			var dataDetailInfo = page.dataDetailInfo
			var json={"data":{"saveDatas":[{"metadata":{"model":[{"object":"iect_uc_buyPlan","fields":[{"code":"prepareDate","name":"编制日期","type":"date","length":"50","precision":"0"},{"code":"inBudget","name":"是否列入采购预算","type":"char","length":"255","precision":"0"},{"code":"statusFlag","name":"审批状态标识","type":"integer","length":"50","precision":"0"},{"code":"preparer","name":"编制人","type":"char","length":"60","precision":"0"},{"code":"buyItem","name":"采购事项","type":"char","length":"2000","precision":"0"},{"code":"buyClassNo","name":"采购分类","type":"char","length":"255","precision":"0"},{"code":"buyNo","name":"采购号","type":"char","length":"50","precision":"0"},{"code":"projectName","name":"项目名称","type":"char","length":"255","precision":"0"},{"code":"emergeTypeNo","name":"紧急程度编号","type":"char","length":"50","precision":"0"},{"code":"buyReason","name":"采购理由","type":"char","length":"2000","precision":"0"},{"code":"buyClass","name":"采购分类","type":"char","length":"255","precision":"0"},{"code":"buylMethod","name":"采购方式","type":"char","length":"50","precision":"0"},{"code":"buyTypeNo","name":"采购类型编号","type":"char","length":"50","precision":"0"},{"code":"emergeType","name":"紧急程度","type":"char","length":"50","precision":"0"},{"code":"perMoney","name":"预估金额（元）","type":"integer","length":"50","precision":"0"},{"code":"projectId","name":"项目ID","type":"char","length":"64","precision":"0"},{"code":"preparerId","name":"编制人Id","type":"char","length":"64","precision":"0"},{"code":"buyMethodNo","name":"采购方式编号","type":"char","length":"50","precision":"0"},{"code":"remark","name":"备注","type":"char","length":"2000","precision":"0"},{"code":"buyType","name":"采购类型","type":"char","length":"50","precision":"0"},{"code":"statusName","name":"审批状态名称","type":"char","length":"60","precision":"0"},{"code":"resultInfo","name":"结果信息","type":"char","length":"2000","precision":"0"},{"code":"id","name":"主键标识","type":"char","length":"64","precision":"0"}]}]},"datas":{"values":[{"prepareDate":"2017-09-11","inBudget":"是","statusFlag":9,"preparer":"丁东升","buyItem":"111111111111111111111111111111","buyClassNo":"S","buyNo":"SP-S-ZR34SYB-CQCHWL-2017-001","projectName":"重庆传化物流基地有限公司新建项目","emergeTypeNo":"较急","buyReason":"11111111111111111111111111111111111111111","buyClass":"设备","buylMethod":"竞争性谈判","buyTypeNo":"10_LXSB","emergeType":"较急","perMoney":-1773790777,"projectId":"0afd221005e67633bd8907622c41cbf6","preparerId":"741476a7c5b178b2bedf1f062d17b26b","buyMethodNo":"ZJ","remark":"1111111111111111111111111111111111","buyType":"零星设备","statusName":"审批通过","resultInfo":null,"id":"2c668e0718d5a02a420ec3545123f7b3","__ds_state__":"insertorupdate"}],"recordCount":0},"dataSource":"iect_uc_buyPlan"}],"saveMode":"cascadeSave","treeStructMapArray":null,"transaction_id":"f4e5c80e34733419049d83d0f22bad63"}};
			json.data.transaction_id=transaction_id;
			json.data.saveDatas[0].datas.values[0].id=actBusinData.bussId;
			json.data.saveDatas[0].datas.values[0].statusFlag='9';// 9 审批通过 // 11 审批不通过
			json.data.saveDatas[0].datas.values[0].statusName='审批通过';
			json.data.saveDatas[0].datas.values[0].buyClass=dataDetailInfo.buyClass;
			json.data.saveDatas[0].datas.values[0].buyClassNo=dataDetailInfo.buyClassNo;
			json.data.saveDatas[0].datas.values[0].buyItem=dataDetailInfo.buyItem;
			json.data.saveDatas[0].datas.values[0].buyMethodNo=dataDetailInfo.buyMethodNo;
			json.data.saveDatas[0].datas.values[0].buyNo=dataDetailInfo.buyNo;
			json.data.saveDatas[0].datas.values[0].buyReason=dataDetailInfo.buyReason;
			json.data.saveDatas[0].datas.values[0].buyType=dataDetailInfo.buyType;
			json.data.saveDatas[0].datas.values[0].buyTypeNo=dataDetailInfo.buyTypeNo;
			json.data.saveDatas[0].datas.values[0].buylMethod=dataDetailInfo.buylMethod;
			json.data.saveDatas[0].datas.values[0].emergeType=dataDetailInfo.emergeType;
			json.data.saveDatas[0].datas.values[0].emergeTypeNo=dataDetailInfo.emergeTypeNo;
			json.data.saveDatas[0].datas.values[0].inBudget=dataDetailInfo.inBudget;
			json.data.saveDatas[0].datas.values[0].perMoney=dataDetailInfo.perMoney;
			json.data.saveDatas[0].datas.values[0].prepareDate=dataDetailInfo.prepareDate;
			json.data.saveDatas[0].datas.values[0].preparer=dataDetailInfo.preparer;
			json.data.saveDatas[0].datas.values[0].preparerId=dataDetailInfo.preparerId;
			json.data.saveDatas[0].datas.values[0].projectId=dataDetailInfo.projectId;
			json.data.saveDatas[0].datas.values[0].projectName=dataDetailInfo.projectName;
			json.data.saveDatas[0].datas.values[0].remark=dataDetailInfo.remark;
			
			var jsonStr = encodeURI(JSON.stringify(json));
			$.ajax({
				type: 'POST',
				url: ip+"module-operation!executeOperation?moduleId="+actBusinData.bussComponentId,
				data: {
					'moduleId':actBusinData.bussComponentId,
					'operation':'Save',
					'ajaxRequest':'true',
					'token':jsonStr
				},
				success: function(result){
					console.log(JSON.stringify(result));
					//result: {"msg":"","data":null,"success":true,"log":""}
					if(result.success==true){
						//7. 办结
						var json={"data":{"ruleInstId":"0aa620aea30b48dea7ffbd7e74ad6e3f","inputParams":{"condParams":[{"dataSource":"oa_form_inst","condition":"(  id  =  :oa_form_inst_id_0_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_inst_id_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d"},"values":[{"destField":"oa_form_inst.formStatus","sourceField":"办结","valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
						json.data.transaction_id=transaction_id;
						json.data.inputParams.condParams[0].parameters.oa_form_inst_id_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
						json.data.inputParams.condParams[0].values[0].sourceField='办结';
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
							data: {
								'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								console.log(JSON.stringify(result));
								//result: {"msg":"","data":null,"success":true,"log":""}
								if(result.success==true){
									var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
									json.data.transaction_id=transaction_id;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'Transaction',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											if(result.success==true){
												mui.toast('提交成功');
												getNum()
												openListWindow();
												sendMessage();	
											}else{mui.toast("提交失败");}
										},
										dataType: "json"
									});
/*									//8. 设置 oa_form_opinion.isTemp
									var json={"data":{"ruleInstId":"e012526261e1477eaf7e22be136f3ed8","inputParams":{"condParams":[{"dataSource":"oa_form_opinion","condition":"(  formInstanceId  =  :oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX and  ISNULL(isTemp, 0)  =  :oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX and  activityId  =  :oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX and  opterId  =  :oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d","oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX":true,"oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX":"4","oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX":"2b1a3838cf668eb9c3b60ff1fa5f2237"},"values":[{"destField":"oa_form_opinion.isTemp","sourceField":false,"valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
									json.data.transaction_id=transaction_id;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX=currentActivitysInfo.ActivityId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX=firstWorkTask.owner;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'WebExecuteRule',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											if(result.success==true){
												// 9. 提交事务
												var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
												json.data.transaction_id=transaction_id;
												var jsonStr = encodeURI(JSON.stringify(json));
												$.ajax({
													type: 'POST',
													url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
													data: {
														'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
														'operation':'Transaction',
														'ajaxRequest':'true',
														'token':jsonStr
													},
													success: function(result){
														if(result.success==true){
															mui.toast('提交成功');
															getNum()
															openListWindow();
															sendMessage();	
														}else{mui.toast("提交失败");}
													},
													dataType: "json"
												});
											}
										},
										dataType: "json"
									});*/
								}
							},
							dataType: "json"
						});
					}
				},
				dataType: "json"
			});
		}else if($.inArray(processCode, ydzfArr) != -1){
			var json;
			if(firstWorkTask.processCode=='XMBYDZF'){ // 项目部月度支付
				json={"data":{"ruleInstId":"fee4ab48405e42048036469dd09b918a","inputParams":{"condParams":[{"dataSource":"iefc_ProjFundPay","condition":"(  id  =  :iefc_ProjFundPay_id_0_CONDITION_KEY_SUFFIX )","parameters":{"iefc_ProjFundPay_id_0_CONDITION_KEY_SUFFIX":"323eae32dbf7ef49c16aeccfaab6f59d"},"values":[{"destField":"iefc_ProjFundPay.statusFlag","sourceField":9,"valueType":"1"},{"destField":"iefc_ProjFundPay.statusName","sourceField":"审批通过","valueType":"1"}]}]},"transaction_id":"541f9087a31503a602a5acbeef4eab23"}};
				json.data.inputParams.condParams[0].parameters.iefc_ProjFundPay_id_0_CONDITION_KEY_SUFFIX=actBusinData.bussId;
			} else if(firstWorkTask.processCode=='SYBYDZF'){//事业部月度支付
				json={"data":{"ruleInstId":"26e22f08e61048efbb86f468104a03de","inputParams":{"condParams":[{"dataSource":"iefc_BuFundPay","condition":"(  id  =  :iefc_BuFundPay_id_0_CONDITION_KEY_SUFFIX )","parameters":{"iefc_BuFundPay_id_0_CONDITION_KEY_SUFFIX":"5169da688bd319613977e4588e152998"},"values":[{"destField":"iefc_BuFundPay.statusFlag","sourceField":9,"valueType":"1"},{"destField":"iefc_BuFundPay.statusName","sourceField":"审批通过","valueType":"1"}]}]},"transaction_id":"24d54f7228d52b4063a2d81e8be94282"}};
				json.data.inputParams.condParams[0].parameters.iefc_BuFundPay_id_0_CONDITION_KEY_SUFFIX=actBusinData.bussId;
			}
			
			json.data.transaction_id=transaction_id;
			json.data.inputParams.condParams[0].values[0].sourceField='9';// 9 审批通过 // 11 审批不通过
			json.data.inputParams.condParams[0].values[1].sourceField='审批通过';
			var jsonStr = encodeURI(JSON.stringify(json));
			$.ajax({
				type: 'POST',
				url: ip+"module-operation!executeOperation?moduleId="+actBusinData.bussComponentId,
				data: {
					'moduleId':actBusinData.bussComponentId,
					'operation':'WebExecuteRule',
					'ajaxRequest':'true',
					'token':jsonStr
				},
				success: function(result){
					$("#resultArea").val(JSON.stringify(result));
					//result: {"msg":"","data":null,"success":true,"log":""}
					if(result.success==true){
						//7. 办结
						var json={"data":{"ruleInstId":"0aa620aea30b48dea7ffbd7e74ad6e3f","inputParams":{"condParams":[{"dataSource":"oa_form_inst","condition":"(  id  =  :oa_form_inst_id_0_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_inst_id_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d"},"values":[{"destField":"oa_form_inst.formStatus","sourceField":"办结","valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
						json.data.transaction_id=transaction_id;
						json.data.inputParams.condParams[0].parameters.oa_form_inst_id_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
						json.data.inputParams.condParams[0].values[0].sourceField='办结';
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url:ip+ "module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
							data: {
								'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								$("#resultArea").val(JSON.stringify(result));
								//result: {"msg":"","data":null,"success":true,"log":""}
								if(result.success==true){
									var json={"data":{"ruleInstId":"e012526261e1477eaf7e22be136f3ed8","inputParams":{"condParams":[{"dataSource":"oa_form_opinion","condition":"(  formInstanceId  =  :oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX and  ISNULL(isTemp, 0)  =  :oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX and  activityId  =  :oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX and  opterId  =  :oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d","oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX":true,"oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX":"4","oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX":"2b1a3838cf668eb9c3b60ff1fa5f2237"},"values":[{"destField":"oa_form_opinion.isTemp","sourceField":false,"valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
									json.data.transaction_id=transaction_id;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX=currentActivitysInfo.ActivityId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX=firstWorkTask.owner;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'WebExecuteRule',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											$("#resultArea").val(JSON.stringify(result));
											//result: {"msg":"","data":null,"success":true,"log":""}
											if(result.success==true){
												// 9. 提交事务
												var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
												json.data.transaction_id=transaction_id;
												var jsonStr = encodeURI(JSON.stringify(json));
												$.ajax({
													type: 'POST',
													url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
													data: {
														'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
														'operation':'Transaction',
														'ajaxRequest':'true',
														'token':jsonStr
													},
													success: function(result){
														console.log(JSON.stringify(result));
														//result: {"msg":"","data":{},"success":true,"log":""}
														if(result.success==true){
															mui.toast('提交成功');
															getNum()
															openListWindow();
															sendMessage();	
														}else{mui.toast("提交失败");}
													},
													dataType: "json"
												});
											}
										},
										dataType: "json"
									});
								}
							},
							dataType: "json"
						});
					}
				},
				dataType: "json"
			});
		}else if(processCode == "XDYWSQD-001"){
			// 设置状态
			var page=plus.webview.getWebviewById("managementLink");
			var bussData = page.bussData;
			var json={"data":{"saveDatas":[{"metadata":{"model":[{"object":"iefc_creditApply","fields":[{"code":"prepareDate","name":"编制日期","type":"date","length":"50","precision":"0"},{"code":"billNo","name":"单据编号","type":"char","length":"150","precision":"0"},{"code":"statusFlag","name":"审批状态标识","type":"integer","length":"16","precision":"0"},{"code":"creditTypeName","name":"本次申请业务","type":"char","length":"255","precision":"0"},{"code":"preparerId","name":"编制人Id","type":"char","length":"60","precision":"0"},{"code":"auditTime","name":"审核时间","type":"longDate","length":"50","precision":"0"},{"code":"remark","name":"长文本","type":"char","length":"1500","precision":"0"},{"code":"allowAmt","name":"核定事业部年度额度（元）","type":"number","length":"50","precision":"4"},{"code":"id","name":"主键标识","type":"char","length":"64","precision":"0"},{"code":"preparer","name":"编制人","type":"char","length":"60","precision":"0"},{"code":"createOrgId","name":"编制单位Id","type":"char","length":"150","precision":"0"},{"code":"thisAmt","name":"本次申请金额（元）","type":"number","length":"50","precision":"4"},{"code":"creditUse","name":"信贷使用情况","type":"char","length":"2000","precision":"0"},{"code":"fundUse","name":"资金用途","type":"char","length":"2000","precision":"0"},{"code":"createOrgName","name":"编制单位","type":"char","length":"255","precision":"0"},{"code":"createOrgNo","name":"编制单位编号","type":"char","length":"150","precision":"0"},{"code":"statusName","name":"审批状态","type":"char","length":"32","precision":"0"},{"code":"creditTypeId","name":"本次申请业务","type":"char","length":"255","precision":"0"}]}]},"datas":{"values":[{"prepareDate":"2017-09-26","billNo":"XDYWSQ-01-2017-012","statusFlag":9,"creditTypeName":"保理","preparerId":"000adminUserId","auditTime":null,"remark":"111","allowAmt":null,"id":"20d74acbc3172fcc3ca560fbc9999e4e","preparer":"系统管理员","createOrgId":"000orgId","thisAmt":111,"creditUse":"111","fundUse":"111","createOrgName":"江苏省南通二建集团有限公司","createOrgNo":"01","statusName":"审批通过","creditTypeId":"04","__ds_state__":"insertorupdate"}],"recordCount":0},"dataSource":"iefc_creditApply"}],"saveMode":"cascadeSave","treeStructMapArray":null,"transaction_id":"34d6ce364993a55c4a898ed472eef30f"}};
			json.data.transaction_id=transaction_id;
			json.data.saveDatas[0].datas.values[0].billNo=bussData.billNo;
			json.data.saveDatas[0].datas.values[0].createOrgId=bussData.createOrgId;
			json.data.saveDatas[0].datas.values[0].createOrgName=bussData.createOrgName;
			json.data.saveDatas[0].datas.values[0].createOrgNo=bussData.createOrgNo;
			json.data.saveDatas[0].datas.values[0].creditTypeId=bussData.creditTypeId;
			json.data.saveDatas[0].datas.values[0].creditTypeName=bussData.creditTypeName;
			json.data.saveDatas[0].datas.values[0].creditUse=bussData.creditUse;
			json.data.saveDatas[0].datas.values[0].fundUse=bussData.fundUse;
			json.data.saveDatas[0].datas.values[0].id=bussData.id;
			json.data.saveDatas[0].datas.values[0].prepareDate=bussData.prepareDate;
			json.data.saveDatas[0].datas.values[0].preparer=bussData.preparer;
			json.data.saveDatas[0].datas.values[0].preparerId=bussData.preparerId;
			json.data.saveDatas[0].datas.values[0].remark=bussData.remark;
			json.data.saveDatas[0].datas.values[0].statusFlag='9';
			json.data.saveDatas[0].datas.values[0].statusName='审批通过';//// 9 审批通过 // 11 审批不通过
			json.data.saveDatas[0].datas.values[0].thisAmt=bussData.billNo;
			var jsonStr = encodeURI(JSON.stringify(json));
			$.ajax({
				type: 'POST',
				url: ip+"module-operation!executeOperation?moduleId="+actBusinData.bussComponentId,
				data: {
					'moduleId':actBusinData.bussComponentId,
					'operation':'Save',
					'ajaxRequest':'true',
					'token':jsonStr
				},
				success: function(result){
					$("#resultArea").val(JSON.stringify(result));
					//result: {"msg":"","data":null,"success":true,"log":""}
					if(result.success==true){
						alert("5. 设置状态  成功");
						//7. 办结
						var json={"data":{"ruleInstId":"0aa620aea30b48dea7ffbd7e74ad6e3f","inputParams":{"condParams":[{"dataSource":"oa_form_inst","condition":"(  id  =  :oa_form_inst_id_0_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_inst_id_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d"},"values":[{"destField":"oa_form_inst.formStatus","sourceField":"办结","valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
						json.data.transaction_id='ace398047c325df3593adb4cfc0a5826';
						json.data.inputParams.condParams[0].parameters.oa_form_inst_id_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
						json.data.inputParams.condParams[0].values[0].sourceField='办结';
						var jsonStr = encodeURI(JSON.stringify(json));
						$.ajax({
							type: 'POST',
							url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
							data: {
								'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
								'operation':'WebExecuteRule',
								'ajaxRequest':'true',
								'token':jsonStr
							},
							success: function(result){
								$("#resultArea").val(JSON.stringify(result));
								//result: {"msg":"","data":null,"success":true,"log":""}
								if(result.success==true){
									alert("7. 办结 成功");
									/*//8. 设置 oa_form_opinion.isTemp
									var json={"data":{"ruleInstId":"e012526261e1477eaf7e22be136f3ed8","inputParams":{"condParams":[{"dataSource":"oa_form_opinion","condition":"(  formInstanceId  =  :oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX and  ISNULL(isTemp, 0)  =  :oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX and  activityId  =  :oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX and  opterId  =  :oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX":"741fe4cf499a808f8ffedd8e8bdb730d","oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX":true,"oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX":"4","oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX":"2b1a3838cf668eb9c3b60ff1fa5f2237"},"values":[{"destField":"oa_form_opinion.isTemp","sourceField":false,"valueType":"1"}]}]},"transaction_id":"c0558df8270077aeb45d9ab77c061d4d"}};
									json.data.transaction_id='ace398047c325df3593adb4cfc0a5826';
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX=currentActivitysInfo.ActivityId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
									json.data.inputParams.condParams[0].parameters.oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX=firstWorkTask.owner;
									var jsonStr = encodeURI(JSON.stringify(json));
									$.ajax({
										type: 'POST',
										url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
										data: {
											'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
											'operation':'WebExecuteRule',
											'ajaxRequest':'true',
											'token':jsonStr
										},
										success: function(result){
											$("#resultArea").val(JSON.stringify(result));
											//result: {"msg":"","data":null,"success":true,"log":""}
											if(result.success==true){
												alert("8. 设置 oa_form_opinion.isTemp 成功");*/
												// 9. 提交事务 
												var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
												json.data.transaction_id='ace398047c325df3593adb4cfc0a5826';
												var jsonStr = encodeURI(JSON.stringify(json));
												$.ajax({
													type: 'POST',
													url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
													data: {
														'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
														'operation':'Transaction',
														'ajaxRequest':'true',
														'token':jsonStr
													},
													success: function(result){
														console.log(JSON.stringify(result));
														if(result.success==true){
															mui.toast('提交成功');
															getNum()
															openListWindow();
															sendMessage();	
														}else{mui.toast("提交失败");}											},
													dataType: "json"
												});
											}else{
												alert("7. 办结 失败");
											}
										},
										dataType: "json"
									});
								}else{
									alert("设置审批状态失败");
								}
							},
							dataType: "json"
						});
					}else{
						alert("开启事务失败");
					}
		
	}
	function queryTodoTaskRefuse(){
		var json={"data":{"ruleInstId":"045c2188a88e466789ef04408f11098a","inputParams":{"moduleId":"f2a41afd81a44eac976c4ea45cb7e6b8","taskId":"4028472d5e574c4f015e575ec661082e","queryCanComplete":true,"queryCanReject":true,"queryCanRetrieve":false}}};
		json.data.inputParams.taskId=firstWorkTask.id;
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
			type: 'POST',
			url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
			data: {
				'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
				'operation':'WebExecuteRule',
				'ajaxRequest':'true',
				'token':jsonStr
			},
			success: function(result){
				// {"msg":"","data":{"CanReject":true,"CanRetrieve":false,"CanComplete":true},"success":true,"log":""}
				console.log(JSON.stringify(result));
				if(result.data.CanReject == true){ // 可以退回
					var json={"ActivityId": "2", "ActivityName": "", "__ds_id__": "", "account": "", "accountId": "", "id": "", "orgId": "", "orgName": "", "userName": ""};
					json.ActivityId='2';
					json.ActivityName=actBusinData.ActivityName;
					json.__ds_id__=actBusinData.senderId;
					//json.account=actBusinData.;
					//json.accountId=actBusinData.;
					json.id=actBusinData.senderId;
					json.orgId=actBusinData.sendOrgId;
					json.orgName=actBusinData.sendOrgName;
					json.userName=actBusinData.senderName;
					firstHistoryActUser=json;
					queryTodoTaskRefuseComplate();
					
				}else{
					mui.toast("不允许退回");
				}
			},
			dataType: "json"
		});
	}
	// 已发起--审批中----退回
	function queryTodoTaskRefuseComplate(){
		/*var json={"data":{"ruleInstId":"d1e38826d83e48df888d206eb2e2117c","inputParams":{"code":"com.toone.itop.formula.function.epm.flow.SetFlowVariable","IsSync":true,"params":[{"param":"executionId","paramvalue":"4028472d5e5b0965015e5b82ce2412d8"},{"param":"variableName","paramvalue":"BizUserIdStr"},{"param":"variableValue","paramvalue":"741476a7c5b178b2bedf1f062d17b26b"}]}}};
		json.data.inputParams.params[0].paramvalue=firstWorkTask.executionId
		json.data.inputParams.params[2].paramvalue=firstHistoryActUser.id;
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
			type: 'POST',
			url: "module-operation!executeOperation?moduleId=4e31efd0daf94bdc8608cdc28b1979e7",
			data: {
				'moduleId':'4e31efd0daf94bdc8608cdc28b1979e7',
				'operation':'WebExecuteRule',
				'ajaxRequest':'true',
				'token':jsonStr
			},
			success: function(result){
				$("#resultArea").val(JSON.stringify(result));
				//result: 
				if(result.success == true){*/
					// 跳到指定 退回节点
					var json={"data":{"ruleInstId":"df49446f21554745b2890f2776776f6f","inputParams":{"taskId":"4028472d5e5b0965015e5b82ce3f12e1","nextActivityIds":"3","nextExecutionUnitIds":"741476a7c5b178b2bedf1f062d17b26b","variables":{"DefaultTaskName":"","DefaultLoginUserId":"2b1a3838cf668eb9c3b60ff1fa5f2237","DefaultLoginUserName":"朱华俊"},"command":"workFlowTaskSkip"}}};
					json.data.inputParams.nextActivityIds=firstHistoryActUser.ActivityId
					json.data.inputParams.nextExecutionUnitIds=firstHistoryActUser.id;
					json.data.inputParams.taskId=firstWorkTask.id;
					json.data.inputParams.variables.DefaultLoginUserId=usedAccountInfo.userId;
					json.data.inputParams.variables.DefaultLoginUserName=usedAccountInfo.userName;
					var jsonStr = encodeURI(JSON.stringify(json));
					$.ajax({
						type: 'POST',
						url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
						data: {
							'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
							'operation':'WebExecuteRule',
							'ajaxRequest':'true',
							'token':jsonStr
						},
						success: function(result){
							console.log(JSON.stringify(result));
							//result: 
							if(result.success == true){
								// 恢复流程走向
								//2. 开启事务
								var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_begin"}};
								json.data.transaction_id=transaction_id; // 事务ID
								var jsonStr = encodeURI(JSON.stringify(json));
								$.ajax({
									type: 'POST',
									url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
									data: {
										'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
										'operation':'Transaction',
										'ajaxRequest':'true',
										'token':jsonStr
									},
									success: function(result){
										console.log(JSON.stringify(result));
										//$("#resultArea").val(JSON.stringify(result));
										//result: {"msg":"","data":{},"success":true,"log":""}
										if(result.success == true){ // 事务开启
											//恢复流程走向-退回
											var json={"data":{"ruleInstId":"b11dc659c97b4d69966f883a6f15d1af","inputParams":{"condParams":[{"dataSource":"oa_form_opinion","condition":"(  formInstanceId  =  :oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX and  ISNULL(isTemp, 0)  =  :oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX and  activityId  =  :oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX and  opterId  =  :oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX )","parameters":{"oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX":"011bf62b032547280c1316622aed1dc2","oa_form_opinion_isTemp_1_CONDITION_KEY_SUFFIX":true,"oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX":"4","oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX":"2b1a3838cf668eb9c3b60ff1fa5f2237"},"values":[{"destField":"oa_form_opinion.isTemp","sourceField":false,"valueType":"1"}]}]},"transaction_id":"e595e443b68a160d4931175b61f5255c"}};
											json.data.transaction_id=transaction_id;
											json.data.inputParams.condParams[0].parameters.oa_form_opinion_activityId_2_CONDITION_KEY_SUFFIX='3';
											json.data.inputParams.condParams[0].parameters.oa_form_opinion_formInstanceId_0_CONDITION_KEY_SUFFIX=firstWorkTask.processInstanceId;
											json.data.inputParams.condParams[0].parameters.oa_form_opinion_opterId_3_CONDITION_KEY_SUFFIX=usedAccountInfo.userId;
											
											var jsonStr = encodeURI(JSON.stringify(json));
											$.ajax({
												type: 'POST',
												url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
												data: {
													'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
													'operation':'Save',
													'ajaxRequest':'true',
													'token':jsonStr
												},
												success: function(result){
													console.log(JSON.stringify(result));
													//result: {"msg":"","data":{},"success":true,"log":""}
													if(result.success == true){ // 恢复流程走向-提交事务
														var json={"data":{"transaction_id":"ace398047c325df3593adb4cfc0a5826","transaction_action":"transaction_commit"}};
														json.data.transaction_id=transaction_id;
														var jsonStr = encodeURI(JSON.stringify(json));
														$.ajax({
															type: 'POST',
															url: ip+"module-operation!executeOperation?moduleId=f2a41afd81a44eac976c4ea45cb7e6b8",
															data: {
																'moduleId':'f2a41afd81a44eac976c4ea45cb7e6b8',
																'operation':'Transaction',
																'ajaxRequest':'true',
																'token':jsonStr
															},
															success: function(result){
																console.log(JSON.stringify(result));
																if(result.success == true){
																	mui.toast('退回成功');
																	getNum()
																	openListWindow();
																	sendMessage();	
																}
															},
															dataType: "json"
														});
													}
												},
												dataType: "json"
											});
										}
									},
									dataType: "json"
								});
							}
						},
						dataType: "json"
					});
		
	}
	//发消息给处理人
	function sendMessage(){
		//console.log(JSON.stringify(nextAsignee))
		if($('#sendMessage').is(':checked')){
			if(nextAsignee==undefined){
				console.log(JSON.stringify(firstHistoryActUser))
				nextAsignee = firstHistoryActUser;
				nextAsignee.ExecutionUnitValue=firstHistoryActUser.id;
			}
			//console.log(JSON.stringify(nextAsignee))
			$.ajax({
				type: 'POST',
				url: ip2 + "app/appPush",
				data: {
					'userId': nextAsignee.ExecutionUnitValue,
					'accountId':nextAsignee.accountId
				},
				success: function(result) {
					console.log(JSON.stringify(result))
				},
				dataType: "json"
			});	
			/*
			var json={"data":{"selectDatas":[{"queryMode":"custom","dataSource":"Query_WF_GetTaskAgentByUserId","queryFrom":"NAME","selectExpression":"Query_WF_GetTaskAgentByUserId","conditionParams":{"loginUserId":{"paramName":"loginUserId","paramValue":"741476a7c5b178b2bedf1f062d17b26b"},"state":{"paramName":"state","paramValue":"Running"},"taskName":{"paramName":"taskName","paramValue":null},"processName":{"paramName":"processName","paramValue":null},"procInstState":{"paramName":"procInstState","paramValue":"Running"},"executionState":{"paramName":"executionState","paramValue":"Running"}},"extraCondition":"1 = 1","recordStart":-1,"pageSize":-1}]}};
			json.data.selectDatas[0].conditionParams.loginUserId.paramValue=nextAsignee.id;				
			var jsonStr = encodeURI(JSON.stringify(json));
			
			$.ajax({
				type: 'POST',
				url: ip+"module-operation!executeOperation?moduleId=2689402522df4981a05c02a9b0559cbb",
				data: {
					'moduleId':'2689402522df4981a05c02a9b0559cbb',
					'operation':'Find',
					'ajaxRequest':'true',
					'token':jsonStr
				},
				success: function(result){
					//console.log(JSON.stringify(result))
					//console.log(JSON.stringify(result.data.resultDatas[0].datas.recordCount))
					if(result.success==true)
					$.ajax({
							type: 'POST',
							url: ip2 + "app/appPush",
							data: {
								'userId': nextAsignee.ExecutionUnitValue,
								'accountId':nextAsignee.accountId
							},
							success: function(result) {
								console.log(JSON.stringify(result))
	
							},
							dataType: "json"
						});	
						//$("#resultArea").val(result.data.resultDatas[0].datas.recordCount);//待办个数
				},
				dataType: "json"
			});*/
		}
	}
	function openListWindow(){
		plus.webview.close('listParent','none');
		var json = {"data":{"selectDatas":[{"queryMode":"custom","dataSource":"Query_WF_GetTaskDbAndCy","queryFrom":"NAME","selectExpression":"Query_WF_GetTaskDbAndCy","conditionParams":{"processName":{"paramName":"processName","paramValue":null},"state":{"paramName":"state","paramValue":"Running"},"procInstState":{"paramName":"procInstState","paramValue":"Running"},"executionState":{"paramName":"executionState","paramValue":"Running"},"loginUserId":{"paramName":"loginUserId","paramValue":"741476a7c5b178b2bedf1f062d17b26b"},"taskName":{"paramName":"taskName","paramValue":null}},"extraCondition":"1 = 1","recordStart":-1,"pageSize":-1}]}};
		json.data.selectDatas[0].conditionParams.loginUserId.paramValue=usedAccountInfo.userId;
		json.data.selectDatas[0].pageSize=15;
		json.data.selectDatas[0].recordStart=1;
		var jsonStr = encodeURI(JSON.stringify(json));
		$.ajax({
			type: 'POST',
			url: ip+"module-operation!executeOperation?moduleId=5de9264496ed421083f487f7dee1ac54",
			data: {
				  'moduleId':'5de9264496ed421083f487f7dee1ac54',
				  'operation':'Find',
				  'ajaxRequest':'true',
				  'token':jsonStr
			},
			success: function(result){
				 var param = result.data.resultDatas[0].datas
				  mui.openWindow({
				  	url:'listParent.html',
				  	id:'listParent',
				  	extras:{
				  		listInfo:param,
				  		status:'daiban'
				  	}
				  })
			},
			error:function(ms){
				mui.toast("网络出错");
			},
			dataType: "json"
		});	
		
	}
	mui('.mui-back-action').on('tap',function(){
		plus.webview.currentWebview().close()
	})
})
</script>

</html>