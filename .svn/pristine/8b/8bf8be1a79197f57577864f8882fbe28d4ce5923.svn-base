<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/app.css" />
		<link rel="stylesheet" type="text/css" href="css/myCss.css" />
		<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	</head>
	<style>
		.mui-table-view-cell{
			border-bottom: 1px solid #EFEFEF;
			color: #709AB3;
		}
		.mui-table-view-cell i{
			margin-right: 5px;
		}
		.mui-ellipsis{
			color: #8F8F94;
			text-align:right;
		}
		#refreshContainer{
			margin-top: -20px;
		}
	</style>
	<body  id="refreshContainer" >
		<div class="mui-content">
			<ul class="mui-table-view mui-table-view-striped mui-table-view-condensed">
			</ul>
		</div>

		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/jquery.js" ></script>
		<script type="text/javascript" src="js/common.js" ></script>
		<script type="text/javascript">
			mui.plusReady(function(){
				var curPage = 1; //默认页码
				var total //总记录数
			    var totalPage  //总页数
			    var m=0;
			    var listValues=[]
				getData()
				function getData(){
					var usedAccountInfo = JSON.parse(plus.storage.getItem('usedAccountInfo'));
					var json = {"data":{"selectDatas":[{"queryMode":"custom","dataSource":"Query_WF_GetTaskDbAndCy","queryFrom":"NAME","selectExpression":"Query_WF_GetTaskDbAndCy","conditionParams":{"processName":{"paramName":"processName","paramValue":null},"state":{"paramName":"state","paramValue":"Running"},"procInstState":{"paramName":"procInstState","paramValue":"Running"},"executionState":{"paramName":"executionState","paramValue":"Running"},"loginUserId":{"paramName":"loginUserId","paramValue":"741476a7c5b178b2bedf1f062d17b26b"},"taskName":{"paramName":"taskName","paramValue":null}},"extraCondition":"1 = 1","recordStart":-1,"pageSize":-1}]}};
					json.data.selectDatas[0].conditionParams.loginUserId.paramValue=usedAccountInfo.userId;
					json.data.selectDatas[0].pageSize=15;
					json.data.selectDatas[0].recordStart=1;
					var jsonStr = encodeURI(JSON.stringify(json));
					$.ajax({
						type: 'POST',
						url: ip+"module-operation!executeOperation?moduleId=5de9264496ed421083f487f7dee1ac54",
						data: {
							  'moduleId':'5de9264496ed421083f487f7dee1ac54',
							  'operation':'Find',
							  'ajaxRequest':'true',
							  'token':jsonStr
						},
						success: function(result){
							var values = result.data.resultDatas[0].datas.values;
						  	for(var i=0;i<values.length;i++){
						  		listValues.push(values[i]);				  		
						  	}
						  	console.log(JSON.stringify(listValues))
							total = result.data.resultDatas[0].datas.recordCount //总记录数
		    				totalPage = Math.ceil(total/15);
							addPageInfo()

						},
						error:function(ms){
							mui.toast("网络出错");
						},
						dataType: "json"
					});						
				}
				function addPageInfo(data){
					for(;m<listValues.length;m++){ 
						$('.mui-content ul').append('<li class="mui-table-view-cell"><p><i class="fa fa-comments-o" aria-hidden="true"></i>'+listValues[m].name+'</p><p class="mui-ellipsis">'+listValues[m].startTime+'</p></li>')
					}
				}
				mui.init({
				  	pullRefresh : {
				    container:'#refreshContainer',//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
				    up : {
				      height:50,//可选.默认50.触发上拉加载拖动距离
				      auto:false,//可选,默认false.自动上拉加载一次
				      contentrefresh : "正在加载...",//可选，正在加载状态时，上拉加载控件上显示的标题内容
				      contentnomore:'没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
				      callback :pullUpFresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
				    },
				    down : {
					      height:50,//可选,默认50.触发下拉刷新拖动距离,
					      auto: false,//可选,默认false.自动下拉刷新一次
					      contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
					      contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
					      contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					      callback :pullDownFresh//必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					}
				  }
				});
				function pullUpFresh() { 
					setTimeout(function(){
						if(curPage < totalPage){
							curPage =curPage+1;
							getData();
						    //1、加载完新数据后，必须执行如下代码，true表示没有更多数据了：
						    //2、若为ajax请求，则需将如下代码放置在处理完ajax响应数据之后
						    mui('#refreshContainer').pullRefresh().endPullupToRefresh();
						}else{
							mui.toast('数据已全部加载',{ duration:'short', type:'div' });
							mui('#refreshContainer').pullRefresh().endPullupToRefresh();
						}
					},1500)
				};
			
				function pullDownFresh() {
					$('.mui-content ul').empty()
					curPage = 1;
					m=0
					listValues=[]
					getData();
					mui('#refreshContainer').pullRefresh().endPulldownToRefresh();
					//注意，加载完新数据后，必须执行如下代码，注意：若为ajax请求，则需将如下代码放置在处理完ajax响应数据之后
					 mui.toast('页面已刷新',{ duration:'short', type:'div' });
				}
			})
		</script>
	</body>

</html>